#!/usr/bin/env node
import {Command}from'commander';import {select,input,confirm}from'@inquirer/prompts';import A from'cli-spinners';import {execa}from'execa';import F from'ora';import*as d from'fs/promises';import I from'os';import y from'path';import r,{z}from'zod';var b=new Command("hello").description("Say hello to the user!").option("-n, --name <name>","Name to greet","World").action(e=>N(e));async function N(e){console.log(`Hello, ${e.name}`);}var C={version:"0.1.18"};var W=r.object({name:r.string(),options:r.array(r.string()),args:r.array(r.string()),action:r.string()}),H=r.object({label:r.string().optional(),version:r.string(),commands:r.array(W)}),$=r.object({name:r.string(),body:r.array(H)});var V=".talos";function k(){return y.join(I.homedir(),V)}function B(e){return y.join(k(),e)}async function E(e){try{return await d.access(e),(await d.stat(e)).isDirectory()}catch{return  false}}async function x(e,n=false){let t=k();if(!await E(t)){if(n&&!await confirm({message:`The .talos directory does not exist in your home folder. Do you want to create it at ${t}?`,default:true}))return null;await d.mkdir(t,{recursive:true});}{let o=B(e);if(!await E(o)){if(n&&!await confirm({message:`The .talos/${e} directory does not exist. Do you want to create it?`,default:true}))return null;await d.mkdir(o,{recursive:true});}return o}}async function P(e){let n=await x("commands",false);if(!n)throw new Error("Commands directory is not available");let t=y.join(n,`${e}.json`);try{await d.access(t);}catch{return}try{let o=await d.readFile(t,"utf-8"),a=JSON.parse(o);return $.parse(a)}catch(o){throw o instanceof SyntaxError?new Error(`Command file "${e}.json" contains invalid JSON: ${o.message}`):o instanceof z.ZodError?new Error(`Command file "${e}.json" has invalid schema: ${o.issues.map(a=>a.message).join(", ")}`):new Error(`Failed to read command file "${e}.json": ${o instanceof Error?o.message:String(o)}`)}}function w(e){return /^<[^>]+>$/.test(e)||/^\[[^\]]+\]$/.test(e)}function T(e,n){let t=[],o=[],a=[];for(let c=0;c<e.length;c+=1){let u=e[c];if(u.startsWith("-")){let g=e[c+1],p=g!==void 0&&!g.startsWith("-"),h=p?g:null;n.has(u)?t.push({flag:u,value:h}):(o.push(u),p&&o.push(g)),p&&(c+=1);continue}a.push(u);}return {flags:t,unknownTokens:o,positionals:a}}var O=new Command("e").description("Execute a command").argument("<name>","Name of the command").argument("[extras...]","Additional arguments and options").allowUnknownOption().passThroughOptions().action((e,n,t)=>q(e,t,n));async function q(e,n,t){let o=await select({message:"Where does Talos need to look for the command?",choices:[{name:"Local",value:"local"},{name:"Internet",value:"internet"}]});await U(e,o,{...n,extras:t});}async function U(e,n,t){if(n==="local"){if(!await x("commands",true)){console.error(`
\u274C Cannot proceed without the .talos/commands directory.`);return}await Z(e,t);}n==="internet"&&console.log(`Looking for ${e} on the internet...`);}async function Z(e,n={}){let t=F({text:"Looking for command locally...",spinner:{frames:A.circleHalves.frames,interval:80}}).start();await new Promise(o=>setTimeout(o,1e3));try{let o=await P(e);if(!o){t.fail(`Command "${e}" not found.`);return}if(t.succeed(`Command "${e}" found locally.`),o.body.length<=0){t.fail(`Command "${e}" exists but has no registered versions.`);return}let a=o.body[0];o.body.length>1&&(a=await select({message:"Select a command version to execute:",choices:o.body.map(f=>({name:`${f.version}${f.label?` - ${f.label}`:""}`,value:f}))})||a);let c=[],u=Array.isArray(n.extras)?n.extras:[],g=new Set(a.commands.flatMap(s=>s.options)),p=T(u,g),h=new Set(p.flags.map(s=>s.flag));for(let s of p.flags)c.push(s.flag),s.value!==null&&c.push(s.value);c.push(...p.unknownTokens),c.push(...p.positionals);for(let s of a.commands){let f=[],z=s.args.filter(i=>w(i)),D=s.args.filter(i=>!w(i));for(let i of z){let m=i.replace(/[\[\]<>]/g,"").trim()||"value",l=await input({message:`What argument are you gonna send? (${m})`});f.push(l);}f.unshift(...D);let v=[...c];if(s.options.length>0&&!s.options.some(m=>h.has(m))){let m=s.options[0],l=await input({message:`What do you want to use for "${m}" argument?`,default:""});l!==""&&v.push(m,l);}for(let i of a.commands){let m=F({text:`Executing command: ${i.name}...`,spinner:{frames:A.circleHalves.frames,interval:80}}).start();try{m.stop();let l=[...f,...v];console.log(`
$ ${i.action} ${l.join(" ")}
`),await execa(i.action,l,{stdio:"inherit"}),console.log(),m.succeed(`Executed command: ${i.name}`);}catch(l){m.fail(`Failed to execute command: ${i.name}`),l instanceof Error&&console.error(`Error: ${l.message}`);}}}}catch(o){t.fail("Failed to load command"),o instanceof Error?console.error(`
\u274C ${o.message}
`):console.error(`
\u274C An unexpected error occurred: ${String(o)}
`);}}process.on("SIGINT",()=>process.exit(0));process.on("SIGTERM",()=>process.exit(0));async function Q(){let e=new Command().name("talos").description("Manage everything.").version(C.version,"-v, --version","display the version number").enablePositionalOptions();e.addCommand(b),e.addCommand(O),e.parse();}Q();//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map